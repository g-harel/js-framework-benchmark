<!DOCTYPE html>
<html lang='en'>
<head>
    <title>okwolo</title>
    <meta charset='UTF-8'>
    <link href='../css/currentStyle.css' rel='stylesheet'/>
</head>
<body>
    <div class='wrapper'></div>
    <script src='./okwolo.js'></script>
    <script>

        const r = () => Math.floor(Math.random() * 8);

        let startTime;
        let lastMeasure;
        let startMeasure = function(name) {
            startTime = performance.now();
            lastMeasure = name;
        }
        let stopMeasure = function() {
            let last = lastMeasure;
            if (lastMeasure) {
                window.setTimeout(function () {
                    lastMeasure = null;
                    let stop = performance.now();
                    let duration = 0;
                    console.log(last+" took "+(stop-startTime));
                }, 0);
            }
        }

        const app = okwolo(document.querySelector('.wrapper'));

        const runTest = (test, name) => {
            startMeasure(name);
            test();
            app.update();
            stopMeasure();
        };

        app.setState(0);

        let state = {
            selected: null,
            highestID: 0,
            rows: [],
        };

        window.state = state;

        const actions = {
            select: (id) => {
                runTest(() => {
                    state.selected = id;
                }, 'select');
            },
            delete: (id) => {
                runTest(() => {
                    const index = state.rows.findIndex((row) => {
                        return row.id === id;
                    });
                    state.rows.splice(index, 1);
                }, 'update');
            },
        };

        const createRows = (count = 0) => {
            const adjectives = ['large', 'small', 'long', 'elegant', 'odd', 'cheap', 'expensive', 'fancy'];
            const colours = ['red', 'yellow', 'blue', 'green', 'pink', 'purple', 'white', 'black'];
            const nouns = ['table', 'chair', 'house', 'desk', 'lamp', 'stool', 'sofa', 'bed'];

            const rows = [];
            for (let i = 0; i < count; ++i) {
                state.highestID++;
                rows.push({
                    label: `${adjectives[r()]} ${colours[r()]} ${nouns[r()]}`,
                    id: state.highestID,
                });
            }
            return rows;
        };

        const tests = [
            {
                label: 'Create 1,000 rows',
                name: 'run',
                onclick: () => {
                    state.rows = createRows(1000);
                },
            },
            {
                label: 'Create 10,000 rows',
                name: 'runlots',
                onclick: () => {
                    state.rows = createRows(10000);
                },
            },
            {
                label: 'Append 1,000 rows',
                name: 'add',
                onclick: () => {
                    state.rows = state.rows.concat(createRows(1000));
                },
            },
            {
                label: 'Update every 10th row',
                name: 'update',
                onclick: () => {
                    for (let i = r(); i < state.rows.length; i += 10) {
                        state.rows[i].label += ' !!!!';
                    }
                },
            },
            {
                label: 'Clear',
                name: 'clear',
                onclick: () => {
                    state.rows = [];
                },
            },
            {
                label: 'Swap Rows',
                name: 'swapRows',
                onclick: () => {
                    if(state.rows.length < 1000) {
                        return;
                    }
                    const temp = Object.assign({}, state.rows[1]);
                    state.rows[1] = Object.assign({}, state.rows[998]);
                    state.rows[998] = temp;
                },
            },
        ];

        const Row = ({id, label}) => (
            ['tr', {key: id, className: {danger: state.selected === id}}, [
                ['td.col-md-1', {}, [
                    id,
                ]],
                ['td.col-md-4', {}, [
                    ['a', {onclick: () => actions.select(id)}, [
                        label,
                    ]],
                ]],
                ['td.col-md-1', {}, [
                    ['a', {onclick: () => actions.delete(id)}, [
                        ['span.glyphicon.glyphicon-remove', {'aria-hidden': 'true'}],
                    ]],
                ]],
                ['td.col-md-6'],
            ]]
        );

        app(() => () => (
            ['div', {}, [
                ['div.container', {}, [
                    ['div.jumbotron', {}, [
                        ['div.row', {}, [
                            ['div.col-md-6', {}, [
                                ['h1', {}, [
                                    'okwolo v2.0.0',
                                ]],
                            ]],
                            ['div.col-md-6', {}, [
                                ['div.row', {},
                                    tests.map(({label, name, onclick}) => (
                                        ['div.col-sm-6.smallpad', {}, [
                                            ['button.btn.btn-primary.btn-block', {
                                                id: name,
                                                type: 'button',
                                                onclick: () => runTest(onclick, name),
                                            }, [
                                                label,
                                            ]]
                                        ]]
                                    ))
                                ],
                            ]],
                        ]],
                    ]],
                    ['table.table.table-hover.table-striped.test-data', {}, [
                        ['tbody', {},
                            state.rows.map(Row),
                        ]
                    ]],
                    ['span.preloadicon.glyphicon.glyphicon-remove', {'aria-hidden': 'true'}],
                ]],
            ]]
        ));

    </script>
</body>
</html>